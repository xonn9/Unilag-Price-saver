<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="Search UNILAG Price Saver for products and compare prices" />
  <title>Search Products - UNILAG Price Saver</title>
  <link rel="stylesheet" href="css/theme.css" />
  <script src="js/realtime-updates.js"></script>
  <style>
    body {
      display: flex;
      flex-direction: column;
    }

    main {
      flex: 1;
      max-width: 1280px;
      margin: 0 auto;
      width: 100%;
      padding: 0 var(--space-md);
    }

    /* ========== HEADER ========== */
    .search-header {
      padding: var(--space-2xl) 0;
      border-bottom: var(--border-width-thin) solid var(--color-border);
    }

    .search-title {
      font-size: var(--font-size-2xl);
      margin-bottom: var(--space-md);
      color: var(--color-text);
    }

    .search-bar {
      display: flex;
      gap: var(--space-sm);
      margin-bottom: var(--space-lg);
    }

    .search-bar input {
      flex: 1;
      padding: var(--space-md) var(--space-lg);
    }

    .search-bar button {
      padding: var(--space-md) var(--space-lg);
    }

    /* ========== FILTERS & SORTING ========== */
    .controls {
      display: flex;
      gap: var(--space-md);
      margin-bottom: var(--space-2xl);
      flex-wrap: wrap;
      align-items: center;
    }

    .sort-select,
    .category-select {
      padding: var(--space-sm) var(--space-md);
      font-size: var(--font-size-sm);
    }

    .results-count {
      color: var(--color-muted);
      font-size: var(--font-size-sm);
    }

    /* ========== PRODUCT GRID ========== */
    .products-section {
      padding: var(--space-2xl) 0;
    }

    .product-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: var(--space-lg);
      margin-bottom: var(--space-2xl);
    }

    .product-card {
      background: var(--color-bg-secondary);
      border: var(--border-width-thin) solid var(--color-border);
      border-radius: var(--border-radius-lg);
      overflow: hidden;
      transition: all var(--transition-base);
      display: flex;
      flex-direction: column;
      height: 100%;
      box-shadow: var(--shadow-sm);
    }

    .product-card:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-lg);
      border-color: var(--color-accent);
    }

    .product-image {
      width: 100%;
      height: 200px;
      background: var(--color-bg);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--color-muted);
      position: relative;
    }

    .product-body {
      padding: var(--space-md);
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .product-title {
      font-size: var(--font-size-sm);
      font-weight: var(--font-weight-semibold);
      margin-bottom: var(--space-sm);
      color: var(--color-text);
      line-height: var(--line-height-tight);
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .product-price {
      font-size: var(--font-size-lg);
      font-weight: var(--font-weight-bold);
      color: var(--color-primary);
      margin-bottom: var(--space-sm);
    }

    .product-store {
      font-size: var(--font-size-xs);
      color: var(--color-text-secondary);
      margin-bottom: var(--space-sm);
    }

    .location-tag {
      display: inline-block;
      background: var(--color-info-bg);
      color: var(--color-info);
      padding: var(--space-xs) var(--space-sm);
      border-radius: var(--border-radius-sm);
      font-size: var(--font-size-xs);
      margin-bottom: var(--space-md);
    }

    .product-actions {
      display: flex;
      gap: var(--space-sm);
      margin-top: auto;
      padding-top: var(--space-md);
      border-top: var(--border-width-thin) solid var(--color-border);
    }

    .product-actions button {
      flex: 1;
      padding: var(--space-sm);
      font-size: var(--font-size-xs);
    }

    /* ========== PAGINATION ========== */
    .pagination {
      display: flex;
      justify-content: center;
      gap: var(--space-sm);
      margin: var(--space-2xl) 0;
      flex-wrap: wrap;
    }

    .pagination button {
      padding: var(--space-sm) var(--space-md);
      border: var(--border-width-thin) solid var(--color-border);
      background: var(--color-bg-secondary);
      color: var(--color-text);
      border-radius: var(--border-radius-md);
      cursor: pointer;
      transition: all var(--transition-fast);
    }

    .pagination button:hover,
    .pagination button.active {
      background: var(--color-primary);
      color: white;
      border-color: var(--color-primary);
    }

    /* ========== EMPTY STATE ========== */
    .empty-state {
      text-align: center;
      padding: var(--space-3xl) var(--space-md);
      color: var(--color-muted);
    }

    .empty-state h3 {
      font-size: var(--font-size-xl);
      margin-bottom: var(--space-md);
      color: var(--color-text);
    }

    .empty-state p {
      margin-bottom: var(--space-lg);
    }

    /* ========== LOADING STATE ========== */
    .loading {
      text-align: center;
      padding: var(--space-3xl) var(--space-md);
      color: var(--color-muted);
    }

    .loading-spinner {
      display: inline-block;
      width: 40px;
      height: 40px;
      border: 3px solid var(--color-border);
      border-top-color: var(--color-accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* ========== RESPONSIVE ========== */
    @media (max-width: 768px) {
      .controls {
        gap: var(--space-sm);
      }

      .product-grid {
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        gap: var(--space-md);
      }

      .product-body {
        padding: var(--space-sm);
      }

      .search-bar {
        flex-direction: column;
      }

      .search-bar button {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <!-- Navigation -->
  <nav style="position: sticky; top: 0; z-index: var(--z-sticky); background: var(--color-bg-secondary); border-bottom: var(--border-width-thin) solid var(--color-border); backdrop-filter: blur(10px);">
    <div style="max-width: 1280px; margin: 0 auto; padding: var(--space-md); display: flex; justify-content: space-between; align-items: center;">
      <a href="/" style="font-size: var(--font-size-xl); font-weight: var(--font-weight-bold); color: var(--color-primary); text-decoration: none;">üí∞ Price Saver</a>
      <div style="display: flex; gap: var(--space-sm);">
        <button class="btn btn-secondary" onclick="goToLogin()" style="padding: var(--space-sm) var(--space-md); font-size: var(--font-size-sm);">Login</button>
        <button class="btn btn-primary" onclick="goToRegister()" style="padding: var(--space-sm) var(--space-md); font-size: var(--font-size-sm);">Sign Up</button>
      </div>
    </div>
  </nav>

  <main>
    <!-- Search Header -->
    <div class="search-header">
      <h1 class="search-title">Search Products</h1>
      <div class="search-bar">
        <input
          type="text"
          id="searchInput"
          placeholder="Search products..."
          onkeyup="handleSearch()"
          aria-label="Search products"
        />
        <button class="btn btn-primary" onclick="handleSearch()">Search</button>
      </div>
    </div>

    <!-- Controls -->
    <div class="controls">
      <select id="categorySelect" class="category-select" onchange="applyFilters()">
        <option value="">All Categories</option>
        <option value="EDIBLES">üçö Edibles</option>
        <option value="DRINKS">ü•§ Drinks</option>
        <option value="NON-EDIBLES">üßº Non-Edibles</option>
      </select>
      <select id="sortSelect" class="sort-select" onchange="applyFilters()">
        <option value="newest">Newest First</option>
        <option value="price-asc">Price: Low to High</option>
        <option value="price-desc">Price: High to Low</option>
        <option value="most-submitted">Most Submitted</option>
      </select>
      <span class="results-count">
        Showing <span id="resultCount">0</span> results
      </span>
    </div>

    <!-- Products Section -->
    <section class="products-section">
      <div class="product-grid" id="productGrid">
        <div class="loading">
          <div class="loading-spinner"></div>
          <p>Loading products...</p>
        </div>
      </div>

      <!-- Pagination -->
      <div class="pagination" id="pagination"></div>
    </section>
  </main>

  <!-- Footer -->
  <footer style="background: var(--color-primary); color: white; padding: var(--space-2xl) var(--space-md); margin-top: var(--space-3xl); text-align: center;">
    <p>&copy; 2024 UNILAG Price Saver. Made with ‚ù§Ô∏è for UNILAG Students</p>
  </footer>

  <script>
    const API_BASE_URL = window.__API_BASE__ || "http://localhost:8000/api";
    const ITEMS_PER_PAGE = 12;
    let currentPage = 1;
    let allProducts = [];
    let filteredProducts = [];

    // ========== UTILITY FUNCTIONS ==========
    function goToLogin() {
      window.location.href = "/login.html";
    }

    function goToRegister() {
      window.location.href = "/login.html?mode=register";
    }

    function goToProductDetail(productId) {
      window.location.href = `/product.html?id=${productId}`;
    }

    // ========== URL PARAMS ==========
    function getQueryParam(param) {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get(param);
    }

    // ========== FETCH & FILTER ==========
    async function loadProducts() {
      try {
        const response = await fetch(`${API_BASE_URL}/items/prices/all`);
        allProducts = await response.json();
        
        // Apply initial search query if present
        const searchQuery = getQueryParam("q");
        const category = getQueryParam("category");
        
        if (searchQuery) {
          document.getElementById("searchInput").value = searchQuery;
        }
        
        if (category) {
          document.getElementById("categorySelect").value = category;
        }
        
        applyFilters();
      } catch (error) {
        console.error("Error loading products:", error);
        document.getElementById("productGrid").innerHTML =
          '<p style="grid-column: 1/-1; text-align: center; color: var(--color-muted);">Unable to load products. Please try again later.</p>';
      }
    }

    function applyFilters() {
      const searchQuery = document.getElementById("searchInput").value.toLowerCase();
      const category = document.getElementById("categorySelect").value;
      const sort = document.getElementById("sortSelect").value;

      // Filter products
      filteredProducts = allProducts.filter((product) => {
        const matchesSearch =
          !searchQuery ||
          product.item_name.toLowerCase().includes(searchQuery) ||
          product.store_name.toLowerCase().includes(searchQuery);
        
        const matchesCategory = !category || product.category === category;
        
        return matchesSearch && matchesCategory;
      });

      // Sort products
      if (sort === "price-asc") {
        filteredProducts.sort((a, b) => a.price - b.price);
      } else if (sort === "price-desc") {
        filteredProducts.sort((a, b) => b.price - a.price);
      } else if (sort === "most-submitted") {
        const counts = {};
        filteredProducts.forEach((p) => {
          counts[p.item_id] = (counts[p.item_id] || 0) + 1;
        });
        filteredProducts.sort((a, b) => (counts[b.item_id] || 0) - (counts[a.item_id] || 0));
      }

      currentPage = 1;
      updateResultsCount();
      renderProducts();
      renderPagination();
    }

    function renderProducts() {
      const start = (currentPage - 1) * ITEMS_PER_PAGE;
      const end = start + ITEMS_PER_PAGE;
      const pageProducts = filteredProducts.slice(start, end);

      if (pageProducts.length === 0) {
        document.getElementById("productGrid").innerHTML =
          '<div class="empty-state" style="grid-column: 1/-1;"><h3>No products found</h3><p>Try adjusting your search or filters</p></div>';
        return;
      }

      const productHTML = pageProducts
        .map(
          (product) => `
        <div class="product-card">
          <div class="product-image">
            <span>üì¶ ${product.item_name || "Product"}</span>
          </div>
          <div class="product-body">
            <h3 class="product-title">${product.item_name || "Unnamed Product"}</h3>
            <div class="product-price" data-item-id="${product.item_id}">‚Ç¶${product.price?.toLocaleString() || "N/A"}</div>
            <div class="product-store">üè™ ${product.store_name || "Unknown Store"}</div>
            <div class="location-tag">üìç Campus Area</div>
          </div>
          <div class="product-actions">
            <button class="btn btn-secondary" onclick="goToProductDetail(${product.item_id})" style="flex: 1;">
              View Details
            </button>
            <button class="btn btn-secondary" onclick="alert('Please login to save items')" style="flex: 1;">
              Save
            </button>
          </div>
        </div>
      `
        )
        .join("");

      document.getElementById("productGrid").innerHTML = productHTML;
    }

    function renderPagination() {
      const totalPages = Math.ceil(filteredProducts.length / ITEMS_PER_PAGE);
      const pagination = document.getElementById("pagination");
      pagination.innerHTML = "";

      if (totalPages <= 1) return;

      // Previous button
      const prevBtn = document.createElement("button");
      prevBtn.textContent = "‚Üê Previous";
      prevBtn.disabled = currentPage === 1;
      prevBtn.onclick = () => {
        if (currentPage > 1) {
          currentPage--;
          renderProducts();
          renderPagination();
          window.scrollTo({ top: 0, behavior: "smooth" });
        }
      };
      pagination.appendChild(prevBtn);

      // Page numbers
      for (let i = 1; i <= totalPages; i++) {
        const btn = document.createElement("button");
        btn.textContent = i;
        btn.className = i === currentPage ? "active" : "";
        btn.onclick = () => {
          currentPage = i;
          renderProducts();
          renderPagination();
          window.scrollTo({ top: 0, behavior: "smooth" });
        };
        pagination.appendChild(btn);
      }

      // Next button
      const nextBtn = document.createElement("button");
      nextBtn.textContent = "Next ‚Üí";
      nextBtn.disabled = currentPage === totalPages;
      nextBtn.onclick = () => {
        if (currentPage < totalPages) {
          currentPage++;
          renderProducts();
          renderPagination();
          window.scrollTo({ top: 0, behavior: "smooth" });
        }
      };
      pagination.appendChild(nextBtn);
    }

    function updateResultsCount() {
      document.getElementById("resultCount").textContent = filteredProducts.length;
    }

    // ========== REAL-TIME PRICE UPDATES ==========
    const priceUpdater = new PriceUpdater(API_BASE_URL.replace("/api", ""));

    function subscribeToRealtimePrices() {
      priceUpdater
        .connect()
        .then(() => {
          // Subscribe to all price updates on search page
          priceUpdater.subscribe(0, (update) => {
            // Find product card with matching item_id and update price
            const productCards = document.querySelectorAll(".product-card");
            productCards.forEach((card) => {
              const priceElement = card.querySelector(".product-price");
              if (priceElement && priceElement.getAttribute("data-item-id") === String(update.itemId)) {
                // Animate price change
                const oldPrice = priceElement.textContent;
                priceElement.textContent = `‚Ç¶${update.price.toLocaleString()}`;
                priceElement.style.animation = "none";
                setTimeout(() => {
                  priceElement.style.animation = "priceFlash 0.6s ease";
                }, 10);
              }
            });
          });
        })
        .catch((e) => {
          console.warn("Real-time updates unavailable:", e);
          // Gracefully continue without real-time updates
        });
    }

    // Add CSS animation for price flashing
    const style = document.createElement("style");
    style.textContent = `
      @keyframes priceFlash {
        0% { background-color: transparent; }
        50% { background-color: var(--color-accent-lighter); }
        100% { background-color: transparent; }
      }
    `;
    document.head.appendChild(style);

    // ========== INITIALIZATION ==========
    document.addEventListener("DOMContentLoaded", () => {
      loadProducts();
      subscribeToRealtimePrices();

      // Allow Enter to submit search
      document.getElementById("searchInput").addEventListener("keypress", (e) => {
        if (e.key === "Enter") {
          handleSearch();
        }
      });

      // Cleanup WebSocket on page unload
      window.addEventListener("beforeunload", () => {
        priceUpdater.disconnect();
      });
    });
  </script>
</body>
</html>
```
