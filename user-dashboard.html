<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>UNILAG Price Saver - Dashboard</title>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA1234567890&libraries=places" async defer></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #007AFF;
            --danger: #FF3B30;
            --success: #34C759;
            --warning: #FF9500;
            --light: #F2F2F7;
            --dark: #000;
            --text: #000;
            --bg: #fff;
            --border: #E5E5EA;
        }

        body.dark-mode {
            --text: #fff;
            --bg: #1C1C1E;
            --border: #38383A;
            --light: #2C2C2E;
        }

        html, body {
            height: 100%;
            width: 100%;
            overflow-x: hidden;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: var(--bg);
            color: var(--text);
            transition: background 0.3s, color 0.3s;
            -webkit-overflow-scrolling: touch;
        }

        body {
            display: flex;
            flex-direction: column;
            position: relative;
        }

        * {
            max-width: 100%;
        }

        /* Header */
        header {
            background: var(--bg);
            border-bottom: 1px solid var(--border);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
            gap: 1rem;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary);
            flex: 1;
        }

        .header-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .dark-mode-toggle {
            position: relative;
            top: auto;
            right: auto;
            z-index: 101;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--primary);
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 10px rgba(0, 122, 255, 0.3);
        }

        .dark-mode-toggle:active {
            transform: scale(0.95);
        }

        /* Navigation Panel */
        .nav-toggle {
            position: relative;
            top: auto;
            left: auto;
            z-index: 101;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--primary);
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 10px rgba(0, 122, 255, 0.3);
        }

        .nav-toggle:active {
            transform: scale(0.95);
        }

        .nav-panel {
            position: fixed;
            top: 0;
            left: -300px;
            width: 300px;
            height: 100vh;
            background: var(--light);
            border-right: 1px solid var(--border);
            padding: 2rem 1rem;
            transition: left 0.3s ease;
            z-index: 999;
            overflow-y: auto;
        }

        .nav-panel.open {
            left: 0;
        }

        .nav-panel h3 {
            margin-bottom: 1.5rem;
            color: var(--primary);
            font-size: 1.1rem;
        }

        .nav-item {
            display: block;
            padding: 0.8rem;
            margin-bottom: 0.5rem;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            text-decoration: none;
        }

        .nav-item:hover {
            background: var(--primary);
            color: white;
        }

        .nav-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            z-index: 998;
        }

        .nav-overlay.open {
            display: block;
        }

        /* Remove fixed positioning from buttons - make them scroll with page */
        @media (max-width: 1024px) {
            .nav-toggle,
            .dark-mode-toggle {
                position: static;
                margin: 1rem;
                display: inline-flex;
            }

            header {
                display: flex;
                gap: 1rem;
                align-items: center;
                flex-wrap: wrap;
            }
        }

        /* Main content */
        .container {
            flex: 1;
            display: grid;
            grid-template-columns: 1fr 3fr;
            gap: 2rem;
            padding: 2rem;
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
            overflow-x: hidden;
            box-sizing: border-box;
        }

        /* Sidebar */
        .sidebar {
            background: var(--light);
            padding: 1.5rem;
            border-radius: 12px;
            border: 1px solid var(--border);
            height: fit-content;
            position: sticky;
            top: 80px;
        }

        .sidebar h2 {
            font-size: 1rem;
            margin-bottom: 1rem;
            color: var(--text);
        }

        .form-section {
            margin-bottom: 2rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        label {
            display: block;
            margin-bottom: 0.4rem;
            font-weight: 500;
            font-size: 0.85rem;
            color: var(--text);
        }

        label .required {
            color: var(--danger);
        }

        input, select {
            width: 100%;
            padding: 0.6rem;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--bg);
            color: var(--text);
            font-size: 0.9rem;
            font-family: inherit;
            transition: border-color 0.2s;
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
        }

        button {
            width: 100%;
            padding: 0.8rem;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9rem;
        }

        button:hover {
            background: #0051D5;
            transform: translateY(-2px);
        }

        button.secondary {
            background: #888;
        }

        /* Main Content */
        .main {
            flex: 1;
        }

        /* Stats Cards */
        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--light);
            padding: 1.5rem;
            border-radius: 12px;
            border: 1px solid var(--border);
            text-align: center;
        }

        .stat-card h4 {
            font-size: 0.85rem;
            color: #888;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
        }

        .stat-card .number {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary);
        }

        /* Filters Section */
        .filters {
            background: var(--light);
            padding: 1.5rem;
            border-radius: 12px;
            border: 1px solid var(--border);
            margin-bottom: 2rem;
        }

        .filters h3 {
            font-size: 0.9rem;
            margin-bottom: 1rem;
            color: var(--text);
            font-weight: 600;
        }

        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        /* Prices Table */
        .prices-section {
            background: var(--light);
            padding: 1.5rem;
            border-radius: 12px;
            border: 1px solid var(--border);
        }

        .prices-section h3 {
            font-size: 1.1rem;
            margin-bottom: 1rem;
            color: var(--text);
            font-weight: 600;
        }

        .prices-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        .prices-table th {
            background: var(--border);
            padding: 0.8rem;
            text-align: left;
            font-weight: 600;
            font-size: 0.8rem;
            text-transform: uppercase;
            color: var(--text);
        }

        .prices-table td {
            padding: 0.8rem;
            border-bottom: 1px solid var(--border);
        }

        .prices-table tbody tr:hover {
            background: var(--border);
        }

        .category-badge {
            display: inline-block;
            padding: 0.3rem 0.6rem;
            background: var(--primary);
            color: white;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .price-value {
            font-weight: 600;
            color: var(--success);
        }

        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #888;
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .container {
                grid-template-columns: 1fr;
            }

            .sidebar {
                position: relative;
                top: auto;
            }
        }

        @media (max-width: 768px) {
            header {
                padding: 1rem;
            }

            .container {
                padding: 1rem;
                gap: 1rem;
            }

            .filter-grid {
                grid-template-columns: 1fr;
            }

            .prices-table {
                font-size: 0.8rem;
            }

            .prices-table th, .prices-table td {
                padding: 0.5rem;
            }
        }

        .success-message {
            background: var(--success);
            color: white;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            display: none;
        }

        .success-message.show {
            display: block;
        }

        /* Location Picker Modal */
        .location-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

        .location-modal.open {
            display: flex;
        }

        .location-modal-content {
            background: var(--bg);
            border-radius: 12px;
            width: 100%;
            max-width: 600px;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .location-modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .location-modal-header h3 {
            margin: 0;
            color: var(--primary);
            font-size: 1.2rem;
        }

        .location-modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text);
            width: 40px;
            height: 40px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .location-modal-body {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem;
        }

        .location-input-group {
            margin-bottom: 1.5rem;
        }

        .location-input-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--text);
        }

        .location-input-group input {
            width: 100%;
            padding: 0.8rem;
            border: 2px solid var(--border);
            border-radius: 8px;
            background: var(--bg);
            color: var(--text);
            font-size: 0.95rem;
            font-family: inherit;
        }

        .location-input-group input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
        }

        .autocomplete-list {
            background: var(--light);
            border: 1px solid var(--border);
            border-radius: 8px;
            max-height: 250px;
            overflow-y: auto;
            margin-top: 0.5rem;
            display: none;
        }

        .autocomplete-list.open {
            display: block;
        }

        .autocomplete-item {
            padding: 0.8rem;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: background 0.2s;
        }

        .autocomplete-item:last-child {
            border-bottom: none;
        }

        .autocomplete-item:hover {
            background: var(--primary);
            color: white;
        }

        .autocomplete-item-main {
            font-weight: 600;
            font-size: 0.9rem;
        }

        .autocomplete-item-secondary {
            font-size: 0.8rem;
            opacity: 0.7;
            margin-top: 0.2rem;
        }

        #map {
            width: 100%;
            height: 400px;
            border-radius: 8px;
            margin: 1rem 0;
            border: 1px solid var(--border);
        }

        .location-coordinates {
            background: var(--light);
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
            font-size: 0.85rem;
            display: none;
        }

        .location-coordinates.show {
            display: block;
        }

        .location-coordinates p {
            margin: 0.3rem 0;
            color: var(--text);
        }

        .location-modal-footer {
            padding: 1.5rem;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
        }

        .location-modal-footer button {
            padding: 0.8rem 1.5rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }

        .location-modal-footer .btn-primary {
            background: var(--primary);
            color: white;
        }

        .location-modal-footer .btn-primary:hover {
            background: #0051D5;
        }

        .location-modal-footer .btn-secondary {
            background: #888;
            color: white;
        }

        .location-modal-footer .btn-secondary:hover {
            background: #666;
        }

        .location-info {
            background: #e3f2fd;
            border-left: 4px solid var(--primary);
            padding: 1rem;
            border-radius: 4px;
            margin-bottom: 1rem;
            font-size: 0.85rem;
            color: #01579b;
        }

        body.dark-mode .location-info {
            background: rgba(33, 150, 243, 0.1);
            color: #90caf9;
        }

        /* Mobile Bottom Navigation */
        .mobile-bottom-nav {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg);
            border-top: 1px solid var(--border);
            padding: 0.5rem 0;
            z-index: 1000;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
        }

        .mobile-bottom-nav.active {
            display: flex;
        }

        .mobile-nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 0.5rem;
            text-decoration: none;
            color: var(--text);
            font-size: 0.75rem;
            transition: all 0.2s;
        }

        .mobile-nav-item.active {
            color: var(--primary);
        }

        .mobile-nav-item span {
            font-size: 1.5rem;
            margin-bottom: 0.2rem;
        }

        /* Price Alert Modal */
        .alert-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

        .alert-modal.open {
            display: flex;
        }

        .alert-modal-content {
            background: var(--bg);
            border-radius: 12px;
            width: 100%;
            max-width: 500px;
            padding: 2rem;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        .alert-bell {
            cursor: pointer;
            font-size: 1.2rem;
            position: relative;
            display: inline-block;
        }

        .alert-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--danger);
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 0.7rem;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .alert-badge.active {
            display: flex;
        }

        /* Retailer Profile Modal */
        .retailer-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            overflow-y: auto;
        }

        .retailer-modal.open {
            display: flex;
        }

        .retailer-modal-content {
            background: var(--bg);
            border-radius: 12px;
            width: 100%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 2rem;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        .retailer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border);
        }

        .retailer-name {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary);
        }

        .verified-badge {
            display: inline-block;
            padding: 0.3rem 0.6rem;
            background: var(--success);
            color: white;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 0.5rem;
        }

        .retailer-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .retailer-stat {
            background: var(--light);
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
        }

        .retailer-stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary);
        }

        .retailer-stat-label {
            font-size: 0.85rem;
            color: #888;
            margin-top: 0.3rem;
        }

        /* Search Autocomplete */
        .search-autocomplete {
            position: relative;
        }

        .search-autocomplete-input {
            width: 100%;
            padding: 0.8rem;
            border: 2px solid var(--border);
            border-radius: 8px;
            background: var(--bg);
            color: var(--text);
            font-size: 0.95rem;
        }

        .search-autocomplete-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            margin-top: 0.5rem;
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .search-results.open {
            display: block;
        }

        .search-result-item {
            padding: 0.8rem;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: background 0.2s;
        }

        .search-result-item:hover {
            background: var(--light);
        }

        .search-result-item:last-child {
            border-bottom: none;
        }

        /* Category Insights */
        .category-insight-card {
            background: var(--light);
            padding: 1.5rem;
            border-radius: 12px;
            border: 1px solid var(--border);
            margin-bottom: 1rem;
        }

        .category-insight-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .category-insight-title {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--primary);
        }

        .trending-item {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem;
            border-bottom: 1px solid var(--border);
        }

        .trending-item:last-child {
            border-bottom: none;
        }

        /* User Reputation */
        .user-reputation {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: var(--light);
            border-radius: 20px;
            font-size: 0.9rem;
        }

        .reputation-score {
            font-weight: bold;
            color: var(--primary);
        }

        .reputation-badge {
            padding: 0.2rem 0.5rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .reputation-trusted {
            background: var(--success);
            color: white;
        }

        .reputation-suspicious {
            background: var(--warning);
            color: white;
        }

        /* Mobile Responsive Improvements */
        @media (max-width: 768px) {
            html, body {
                height: 100vh;
                overflow-x: hidden;
                position: fixed;
                width: 100%;
            }

            .mobile-bottom-nav {
                display: flex;
            }

            body {
                padding-bottom: 70px;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
            }

            header {
                padding: 0.8rem 1rem;
                position: sticky;
                top: 0;
                z-index: 1000;
            }

            .logo {
                font-size: 1rem;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            .header-actions {
                font-size: 0.7rem;
                gap: 0.5rem;
            }

            .dark-mode-toggle,
            .nav-toggle {
                width: 40px;
                height: 40px;
                font-size: 1.2rem;
            }

            .container {
                padding: 1rem;
                padding-bottom: 5rem;
                grid-template-columns: 1fr;
                max-width: 100%;
                overflow-x: hidden;
            }

            .sidebar {
                position: relative;
                top: auto;
                margin-bottom: 1rem;
                padding: 1rem;
            }

            .sidebar h2 {
                font-size: 0.9rem;
            }

            .form-group {
                margin-bottom: 0.8rem;
            }

            .form-group label {
                font-size: 0.8rem;
            }

            .form-group input,
            .form-group select {
                padding: 0.5rem;
                font-size: 0.85rem;
            }

            button {
                padding: 0.7rem;
                font-size: 0.85rem;
            }

            .stats-cards {
                grid-template-columns: repeat(2, 1fr);
                gap: 0.6rem;
                margin-bottom: 1rem;
            }

            .stat-card {
                padding: 0.8rem;
            }

            .stat-card h4 {
                font-size: 0.7rem;
            }

            .stat-card .number {
                font-size: 1.3rem;
            }

            .filters {
                padding: 1rem;
                margin-bottom: 1rem;
            }

            .filters h3 {
                font-size: 0.85rem;
                margin-bottom: 0.8rem;
            }

            .filter-grid {
                grid-template-columns: 1fr;
                gap: 0.8rem;
            }

            .prices-section {
                padding: 1rem;
            }

            .prices-section h3 {
                font-size: 0.9rem;
                margin-bottom: 0.8rem;
            }

            /* Keep icons visible on mobile */
            .category-badge,
            .alert-bell,
            .mobile-nav-item span,
            .logo {
                font-size: inherit !important;
            }

            .nav-panel {
                width: 280px;
            }

            /* Modal adjustments for mobile */
            .alert-modal-content,
            .retailer-modal-content {
                max-width: 95%;
                padding: 1.5rem;
                max-height: 85vh;
            }

            .location-modal-content {
                max-width: 95%;
                max-height: 90vh;
            }
        }

        @media (min-width: 769px) {
            .mobile-bottom-nav {
                display: none !important;
            }
        }
    </style>

</head>
<body>
    <header>
        <button class="nav-toggle" id="navToggleBtn" title="Navigation">‚ò∞</button>
        <div class="logo">üõí UNILAG Price Saver</div>
        <div class="header-actions">
            <span id="user-info">User: Student</span>
            <button class="dark-mode-toggle" id="darkModeBtn" title="Toggle dark mode">üåô</button>
        </div>
    </header>

    <div class="nav-overlay" id="navOverlay"></div>
    <div class="nav-panel" id="navPanel">
        <h3>üì± Navigation</h3>
        <a href="user-dashboard.html" class="nav-item">üìä Dashboard</a>
        <a href="#" onclick="showTrends()" class="nav-item">üìà Trends</a>
        <a href="#" onclick="showCategoryInsights()" class="nav-item">üìä Category Insights</a>
        <a href="#" onclick="showMyAlerts()" class="nav-item">üîî My Alerts</a>
        <a href="#" onclick="showProfile()" class="nav-item">üë§ Profile</a>
        <a href="#" onclick="logout()" class="nav-item">üö™ Logout</a>
    </div>

    <!-- Location Picker Modal -->
    <div class="location-modal" id="locationModal">
        <div class="location-modal-content">
            <div class="location-modal-header">
                <h3>üìç Pick Location</h3>
                <button class="location-modal-close" id="locationModalClose">&times;</button>
            </div>
            <div class="location-modal-body">
                <div class="location-info">
                    üí° Click on the map to select a location or search for a place below
                </div>

                <div class="location-input-group">
                    <label for="locationSearch">Search Location</label>
                    <input type="text" id="locationSearch" placeholder="e.g., UNILAG, Shoprite Ikeja, Lekki">
                    <div class="autocomplete-list" id="autocompleteList"></div>
                </div>

                <div id="map"></div>

                <div class="location-coordinates" id="locationCoordinates">
                    <p><strong>Selected Location:</strong></p>
                    <p id="selectedAddress">-</p>
                    <p>Latitude: <span id="selectedLat">-</span></p>
                    <p>Longitude: <span id="selectedLng">-</span></p>
                </div>

                <div class="location-input-group">
                    <label for="manualLocation">Or Enter Location Manually</label>
                    <input type="text" id="manualLocation" placeholder="e.g., Main Campus, Federal College Road">
                </div>
            </div>
            <div class="location-modal-footer">
                <button class="btn-secondary" id="locationModalCancel">Cancel</button>
                <button class="btn-primary" id="locationModalConfirm">Confirm Location</button>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Sidebar: Add Price Form -->
        <aside class="sidebar">
            <h2>Submit Price</h2>
            <div class="success-message" id="successMsg">‚úÖ Price submitted successfully!</div>
            
            <div class="form-section">
                <form id="priceForm">
                    <div class="form-group">
                        <label for="category">
                            Category <span class="required">*</span>
                        </label>
                        <select id="category" required>
                            <option value="">Select category...</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="itemName">
                            Item Name <span class="required">*</span>
                        </label>
                        <input type="text" id="itemName" placeholder="e.g., Rice, Peak Milk" required>
                    </div>

                    <div class="form-group">
                        <label for="brand">Brand</label>
                        <input type="text" id="brand" placeholder="e.g., Peak, Farmer's Choice">
                    </div>

                    <div class="form-group">
                        <label for="packSize">Pack Size</label>
                        <input type="text" id="packSize" placeholder="e.g., 500, 1000">
                    </div>

                    <div class="form-group">
                        <label for="packUnit">Pack Unit</label>
                        <select id="packUnit">
                            <option value="">Select unit...</option>
                            <option value="g">Grams (g)</option>
                            <option value="kg">Kilograms (kg)</option>
                            <option value="ml">Milliliters (ml)</option>
                            <option value="L">Liters (L)</option>
                            <option value="pcs">Pieces (pcs)</option>
                            <option value="pack">Pack</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="price">
                            Price (‚Ç¶) <span class="required">*</span>
                        </label>
                        <input type="number" id="price" step="0.01" placeholder="Enter price" required>
                    </div>

                    <div class="form-group">
                        <label for="pricePerUnit">Price Per Unit (‚Ç¶)</label>
                        <input type="number" id="pricePerUnit" step="0.01" placeholder="Calculated per 100g/ml">
                    </div>

                    <div class="form-group">
                        <label for="retailer">Retailer</label>
                        <input type="text" id="retailer" placeholder="Store/Shop name">
                    </div>

                    <div class="form-group">
                        <label for="location">Location</label>
                        <div style="display: flex; gap: 0.5rem;">
                            <input type="text" id="location" placeholder="Area/Campus location" style="flex: 1;">
                            <button type="button" id="mapPickerBtn" style="width: auto; padding: 0.6rem 1rem; background: var(--success); color: white;" title="Pick location from map">üìç</button>
                        </div>
                    </div>

                    <button type="submit">Submit Price</button>
                </form>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main">
            <!-- Stats -->
            <div class="stats-cards">
                <div class="stat-card">
                    <h4>Total Prices</h4>
                    <div class="number" id="totalPrices">0</div>
                </div>
                <div class="stat-card">
                    <h4>Average Price</h4>
                    <div class="number" id="avgPrice">‚Ç¶0</div>
                </div>
                <div class="stat-card">
                    <h4>Locations</h4>
                    <div class="number" id="totalLocations">0</div>
                </div>
                <div class="stat-card">
                    <h4>Retailers</h4>
                    <div class="number" id="totalRetailers">0</div>
                </div>
            </div>

            <!-- Filters -->
            <div class="filters">
                <h3>üîç Filters</h3>
                <div class="search-autocomplete" style="margin-bottom: 1rem;">
                    <input type="text" id="globalSearch" class="search-autocomplete-input" placeholder="üîç Search items, retailers, locations...">
                    <div class="search-results" id="searchResults"></div>
                </div>
                <div class="filter-grid">
                    <div>
                        <label for="filterCategory">Category</label>
                        <select id="filterCategory">
                            <option value="">All Categories</option>
                        </select>
                    </div>
                    <div>
                        <label for="filterMinPrice">Min Price (‚Ç¶)</label>
                        <input type="number" id="filterMinPrice" placeholder="0" step="0.01">
                    </div>
                    <div>
                        <label for="filterMaxPrice">Max Price (‚Ç¶)</label>
                        <input type="number" id="filterMaxPrice" placeholder="999999" step="0.01">
                    </div>
                    <div>
                        <label for="filterRetailer">Retailer</label>
                        <input type="text" id="filterRetailer" placeholder="Search retailer...">
                    </div>
                    <div>
                        <label for="filterLocation">Location</label>
                        <input type="text" id="filterLocation" placeholder="Search location...">
                    </div>
                    <div>
                        <label>&nbsp;</label>
                        <button class="secondary" onclick="resetFilters()">Reset Filters</button>
                    </div>
                </div>
            </div>

            <!-- Prices Table -->
            <div class="prices-section">
                <h3>üìä Current Prices</h3>
                <div id="pricesContainer">
                    <div class="empty-state">
                        <p>No prices available yet. Start by submitting a price above!</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Mobile Bottom Navigation -->
    <nav class="mobile-bottom-nav" id="mobileBottomNav">
        <a href="#" class="mobile-nav-item active" onclick="showHome(); return false;">
            <span>üè†</span>
            <span>Home</span>
        </a>
        <a href="#" class="mobile-nav-item" onclick="showTrends(); return false;">
            <span>üìà</span>
            <span>Trends</span>
        </a>
        <a href="#" class="mobile-nav-item" onclick="scrollToSubmit(); return false;">
            <span>üí∞</span>
            <span>Submit</span>
        </a>
        <a href="#" class="mobile-nav-item" onclick="openLocationPicker(); return false;">
            <span>üó∫Ô∏è</span>
            <span>Map</span>
        </a>
        <a href="#" class="mobile-nav-item" onclick="showProfile(); return false;">
            <span>üë§</span>
            <span>Profile</span>
        </a>
    </nav>

    <!-- Price Alert Modal -->
    <div class="alert-modal" id="alertModal">
        <div class="alert-modal-content">
            <h3 style="margin-bottom: 1rem; color: var(--primary);">üîî Set Price Alert</h3>
            <div class="form-group">
                <label>Item Name</label>
                <input type="text" id="alertItemName" readonly style="background: var(--light);">
            </div>
            <div class="form-group">
                <label>Notify me when price is below (‚Ç¶)</label>
                <input type="number" id="alertThreshold" step="0.01" placeholder="e.g., 900">
            </div>
            <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                <button class="secondary" onclick="closeAlertModal()" style="flex: 1;">Cancel</button>
                <button onclick="savePriceAlert()" style="flex: 1;">Save Alert</button>
            </div>
        </div>
    </div>

    <!-- Retailer Profile Modal -->
    <div class="retailer-modal" id="retailerModal">
        <div class="retailer-modal-content">
            <div class="retailer-header">
                <div>
                    <span class="retailer-name" id="retailerProfileName">-</span>
                    <span class="verified-badge" id="retailerVerified" style="display: none;">‚úì Verified</span>
                </div>
                <button onclick="closeRetailerModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text);">&times;</button>
            </div>
            
            <div class="retailer-stats">
                <div class="retailer-stat">
                    <div class="retailer-stat-value" id="retailerAvgPrice">-</div>
                    <div class="retailer-stat-label">Avg Price Score</div>
                </div>
                <div class="retailer-stat">
                    <div class="retailer-stat-value" id="retailerLocation">-</div>
                    <div class="retailer-stat-label">Location</div>
                </div>
                <div class="retailer-stat">
                    <div class="retailer-stat-value" id="retailerItemsCount">0</div>
                    <div class="retailer-stat-label">Items Listed</div>
                </div>
            </div>

            <div class="category-insight-card">
                <h4 style="margin-bottom: 1rem;">üí∞ Cheapest Items</h4>
                <div id="retailerCheapestItems">Loading...</div>
            </div>

            <div class="category-insight-card">
                <h4 style="margin-bottom: 1rem;">üî• Top Items</h4>
                <div id="retailerTopItems">Loading...</div>
            </div>
        </div>
    </div>

    <!-- Category Insights Modal -->
    <div class="alert-modal" id="categoryInsightsModal">
        <div class="alert-modal-content" style="max-width: 700px; max-height: 90vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <h3 style="color: var(--primary);">üìä Category Insights</h3>
                <button onclick="closeCategoryInsights()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text);">&times;</button>
            </div>
            <div id="categoryInsightsContent"></div>
        </div>
    </div>

    <!-- Profile Modal -->
    <div class="alert-modal" id="profileModal">
        <div class="alert-modal-content" style="max-width: 600px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <h3 style="color: var(--primary);">üë§ My Profile</h3>
                <button onclick="closeProfileModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text);">&times;</button>
            </div>
            <div id="profileContent">
                <div class="user-reputation" style="margin-bottom: 1.5rem;">
                    <span>‚≠ê</span>
                    <span class="reputation-score" id="userReputationScore">4.6</span>
                    <span class="reputation-badge reputation-trusted" id="userReputationBadge">Trusted User</span>
                </div>
                <div class="form-group">
                    <label>Username</label>
                    <input type="text" id="profileUsername" readonly style="background: var(--light);">
                </div>
                <div class="form-group">
                    <label>Total Submissions</label>
                    <input type="text" id="profileSubmissions" readonly style="background: var(--light);">
                </div>
                <div class="form-group">
                    <label>Points Balance</label>
                    <input type="text" id="profilePoints" readonly style="background: var(--light);">
                </div>
                <div style="margin-top: 1.5rem;">
                    <h4 style="margin-bottom: 1rem;">üîî My Price Alerts</h4>
                    <div id="profileAlertsList"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'http://172.16.142.74:8000';
        let allPrices = [];
        let allCategories = [];
        let selectedLocation = null;
        let map = null;
        let mapMarker = null;

        // Access Control - Check if user is not admin
        window.addEventListener('DOMContentLoaded', () => {
            const userRole = localStorage.getItem('userRole');
            if (userRole === 'admin') {
                alert('‚ùå Please use the Admin Dashboard for admin access.');
                window.location.href = 'admin-dashboard.html';
            }
        });

        // ===== LOCATION PICKER FUNCTIONALITY =====

        // Initialize location picker modal
        const locationModal = document.getElementById('locationModal');
        const locationModalClose = document.getElementById('locationModalClose');
        const locationModalCancel = document.getElementById('locationModalCancel');
        const locationModalConfirm = document.getElementById('locationModalConfirm');
        const mapPickerBtn = document.getElementById('mapPickerBtn');
        const locationSearch = document.getElementById('locationSearch');
        const autocompleteList = document.getElementById('autocompleteList');
        const manualLocation = document.getElementById('manualLocation');

        // Open location picker
        mapPickerBtn.addEventListener('click', () => {
            locationModal.classList.add('open');
            setTimeout(() => {
                if (!map) {
                    initMap();
                }
            }, 300);
        });

        // Close location picker
        locationModalClose.addEventListener('click', () => locationModal.classList.remove('open'));
        locationModalCancel.addEventListener('click', () => locationModal.classList.remove('open'));

        // Initialize Google Map
        function initMap() {
            const defaultLocation = { lat: 6.5244, lng: 3.3792 }; // UNILAG coordinates
            map = new google.maps.Map(document.getElementById('map'), {
                zoom: 14,
                center: defaultLocation,
                mapTypeControl: true,
                fullscreenControl: true,
                zoomControl: true,
            });

            // Add click listener to map
            map.addListener('click', (e) => {
                const lat = e.latLng.lat();
                const lng = e.latLng.lng();
                setSelectedLocation(lat, lng);
            });
        }

        // Set selected location and reverse geocode
        async function setSelectedLocation(lat, lng) {
            selectedLocation = { lat, lng };

            // Update or create marker
            if (mapMarker) {
                mapMarker.setPosition({ lat, lng });
            } else {
                mapMarker = new google.maps.Marker({
                    position: { lat, lng },
                    map: map,
                    title: 'Selected Location'
                });
            }

            // Center map on marker
            map.setCenter({ lat, lng });

            // Try to reverse geocode
            try {
                const response = await fetch(`${API_URL}/maps/reverse-geocode?latitude=${lat}&longitude=${lng}`);
                const data = await response.json();

                if (data.success && data.location) {
                    selectedLocation.address = data.location.address;
                    displayLocationCoordinates(data.location.address, lat, lng);
                } else {
                    displayLocationCoordinates(`Lat: ${lat.toFixed(4)}, Lng: ${lng.toFixed(4)}`, lat, lng);
                }
            } catch (error) {
                console.error('Reverse geocoding error:', error);
                displayLocationCoordinates(`Lat: ${lat.toFixed(4)}, Lng: ${lng.toFixed(4)}`, lat, lng);
            }
        }

        // Display location coordinates
        function displayLocationCoordinates(address, lat, lng) {
            const coordsDiv = document.getElementById('locationCoordinates');
            document.getElementById('selectedAddress').textContent = address;
            document.getElementById('selectedLat').textContent = lat.toFixed(6);
            document.getElementById('selectedLng').textContent = lng.toFixed(6);
            coordsDiv.classList.add('show');
        }

        // Location search with autocomplete
        let autocompleteTimeout;
        locationSearch.addEventListener('input', async (e) => {
            const query = e.target.value.trim();

            clearTimeout(autocompleteTimeout);
            autocompleteList.classList.remove('open');

            if (query.length < 2) {
                autocompleteList.innerHTML = '';
                return;
            }

            autocompleteTimeout = setTimeout(async () => {
                try {
                    const response = await fetch(`${API_URL}/maps/search/autocomplete?input_text=${encodeURIComponent(query)}`);
                    const data = await response.json();

                    if (data.success && data.predictions.length > 0) {
                        autocompleteList.innerHTML = data.predictions.map((pred, idx) => `
                            <div class="autocomplete-item" onclick="selectAutocompletePlace('${pred.place_id}', '${pred.description.replace(/'/g, "\\'")}')">
                                <div class="autocomplete-item-main">${pred.main_text}</div>
                                ${pred.secondary_text ? `<div class="autocomplete-item-secondary">${pred.secondary_text}</div>` : ''}
                            </div>
                        `).join('');
                        autocompleteList.classList.add('open');
                    } else {
                        autocompleteList.innerHTML = '<div class="autocomplete-item" style="cursor: default;">No results found</div>';
                        autocompleteList.classList.add('open');
                    }
                } catch (error) {
                    console.error('Autocomplete error:', error);
                    autocompleteList.classList.remove('open');
                }
            }, 300);
        });

        // Select place from autocomplete
        window.selectAutocompletePlace = async (placeId, description) => {
            try {
                const response = await fetch(`${API_URL}/maps/place/${placeId}`);
                const data = await response.json();

                if (data.success && data.place) {
                    setSelectedLocation(data.place.latitude, data.place.longitude);
                    locationSearch.value = data.place.address;
                    autocompleteList.classList.remove('open');
                }
            } catch (error) {
                console.error('Place details error:', error);
            }
        };

        // Confirm location selection
        locationModalConfirm.addEventListener('click', () => {
            let finalLocation = '';

            if (manualLocation.value.trim()) {
                finalLocation = manualLocation.value.trim();
            } else if (selectedLocation && selectedLocation.address) {
                finalLocation = selectedLocation.address;
            } else if (selectedLocation) {
                finalLocation = `${selectedLocation.lat.toFixed(4)}, ${selectedLocation.lng.toFixed(4)}`;
            }

            if (finalLocation) {
                document.getElementById('location').value = finalLocation;
                locationModal.classList.remove('open');
                manualLocation.value = '';
                autocompleteList.innerHTML = '';
            } else {
                alert('Please select a location or enter it manually');
            }
        });

        // ===== ORIGINAL NAVIGATION & DASHBOARD FUNCTIONALITY =====
        const navToggleBtn = document.getElementById('navToggleBtn');
        const navPanel = document.getElementById('navPanel');
        const navOverlay = document.getElementById('navOverlay');

        navToggleBtn.addEventListener('click', () => {
            navPanel.classList.toggle('open');
            navOverlay.classList.toggle('open');
        });

        navOverlay.addEventListener('click', () => {
            navPanel.classList.remove('open');
            navOverlay.classList.remove('open');
        });

        // Dark Mode Toggle
        const darkModeBtn = document.getElementById('darkModeBtn');
        darkModeBtn.addEventListener('click', () => {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            localStorage.setItem('darkMode', isDark);
            darkModeBtn.textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
        });

        // Load dark mode preference
        if (localStorage.getItem('darkMode') === 'true') {
            document.body.classList.add('dark-mode');
            darkModeBtn.textContent = '‚òÄÔ∏è';
        }

        // Load categories
        async function loadCategories() {
            try {
                const response = await fetch(`${API_URL}/items/categories/all`);
                const categories = await response.json();
                allCategories = categories;

                const categorySelect = document.getElementById('category');
                const filterSelect = document.getElementById('filterCategory');

                categories.forEach(cat => {
                    const option1 = document.createElement('option');
                    option1.value = cat.id;
                    option1.textContent = `${cat.icon || ''} ${cat.name}`;
                    categorySelect.appendChild(option1);

                    const option2 = document.createElement('option');
                    option2.value = cat.id;
                    option2.textContent = `${cat.icon || ''} ${cat.name}`;
                    filterSelect.appendChild(option2);
                });
            } catch (error) {
                console.error('Error loading categories:', error);
            }
        }

        // Load all prices
        async function loadPrices() {
            try {
                const response = await fetch(`${API_URL}/items/prices/all`);
                const prices = await response.json();
                allPrices = prices;
                displayPrices(prices);
                updateStats(prices);
            } catch (error) {
                console.error('Error loading prices:', error);
            }
        }

        // Display prices in table
        function displayPrices(prices) {
            const container = document.getElementById('pricesContainer');

            if (prices.length === 0) {
                container.innerHTML = `<div class="empty-state"><p>No prices match your filters.</p></div>`;
                return;
            }

            const isMobile = window.innerWidth <= 768;
            
            if (isMobile) {
                // Mobile card layout
                container.innerHTML = prices.map(p => {
                    const category = allCategories.find(c => c.id === p.category_id);
                    return `
                        <div style="background: var(--light); padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border: 1px solid var(--border);">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                                <div>
                                    <span class="category-badge">${category?.icon || ''} ${category?.name || 'Unknown'}</span>
                                    <h4 style="margin: 0.5rem 0; color: var(--text);">${p.name}</h4>
                                </div>
                                <span class="alert-bell" onclick="event.stopPropagation(); openAlertModal('${p.name.replace(/'/g, "\\'")}', ${p.price});" style="cursor: pointer;">üîî<span class="alert-badge"></span></span>
                            </div>
                            <div style="font-size: 1.5rem; font-weight: bold; color: var(--success); margin: 0.5rem 0;">‚Ç¶${p.price.toFixed(2)}</div>
                            <div style="font-size: 0.85rem; color: #888; margin-bottom: 0.5rem;">
                                ${p.brand ? `<div>Brand: ${p.brand}</div>` : ''}
                                ${p.pack_size ? `<div>Pack: ${p.pack_size}${p.pack_unit ? ' ' + p.pack_unit : ''}</div>` : ''}
                                ${p.price_per_unit ? `<div>Per Unit: ‚Ç¶${p.price_per_unit.toFixed(2)}</div>` : ''}
                            </div>
                            <div style="border-top: 1px solid var(--border); padding-top: 0.5rem; margin-top: 0.5rem;">
                                <div style="font-size: 0.85rem; margin-bottom: 0.3rem;">
                                    <strong style="color: var(--primary); cursor: pointer;" onclick="showRetailerProfile('${(p.retailer || '').replace(/'/g, "\\'")}');">üè™ ${p.retailer || '-'}</strong>
                                </div>
                                <div style="font-size: 0.85rem; color: #888;">
                                    üìç ${p.location || '-'}
                                </div>
                                <div style="font-size: 0.75rem; color: #888; margin-top: 0.3rem;">
                                    ${new Date(p.submitted_at).toLocaleDateString()}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            } else {
                // Desktop table layout
                const table = document.createElement('table');
                table.className = 'prices-table';
                table.innerHTML = `
                    <thead>
                        <tr>
                            <th>Category</th>
                            <th>Item</th>
                            <th>Brand</th>
                            <th>Pack</th>
                            <th>Price (‚Ç¶)</th>
                            <th>Per Unit</th>
                            <th>Retailer</th>
                            <th>Location</th>
                            <th>Date</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${prices.map(p => `
                            <tr>
                                <td><span class="category-badge">${allCategories.find(c => c.id === p.category_id)?.icon || ''} ${allCategories.find(c => c.id === p.category_id)?.name || 'Unknown'}</span></td>
                                <td>${p.name} <span class="alert-bell" onclick="event.stopPropagation(); openAlertModal('${p.name.replace(/'/g, "\\'")}', ${p.price});" style="cursor: pointer;">üîî<span class="alert-badge"></span></span></td>
                                <td>${p.brand || '-'}</td>
                                <td>${p.pack_size ? `${p.pack_size}${p.pack_unit ? ' ' + p.pack_unit : ''}` : '-'}</td>
                                <td class="price-value">‚Ç¶${p.price.toFixed(2)}</td>
                                <td>${p.price_per_unit ? `‚Ç¶${p.price_per_unit.toFixed(2)}` : '-'}</td>
                                <td style="cursor: pointer; color: var(--primary); text-decoration: underline;" onclick="showRetailerProfile('${(p.retailer || '').replace(/'/g, "\\'")}');">${p.retailer || '-'}</td>
                                <td>${p.location || '-'}</td>
                                <td>${new Date(p.submitted_at).toLocaleDateString()}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                `;
                container.innerHTML = '';
                container.appendChild(table);
            }
        }

        // Update statistics
        function updateStats(prices) {
            document.getElementById('totalPrices').textContent = prices.length;
            const avg = prices.length > 0 ? (prices.reduce((sum, p) => sum + p.price, 0) / prices.length).toFixed(2) : '0';
            document.getElementById('avgPrice').textContent = `‚Ç¶${avg}`;

            const locations = new Set(prices.map(p => p.location).filter(l => l));
            document.getElementById('totalLocations').textContent = locations.size;

            const retailers = new Set(prices.map(p => p.retailer).filter(r => r));
            document.getElementById('totalRetailers').textContent = retailers.size;
        }

        // Filter prices
        function applyFilters() {
            const categoryId = document.getElementById('filterCategory').value;
            const minPrice = parseFloat(document.getElementById('filterMinPrice').value) || 0;
            const maxPrice = parseFloat(document.getElementById('filterMaxPrice').value) || Infinity;
            const retailer = document.getElementById('filterRetailer').value.toLowerCase();
            const location = document.getElementById('filterLocation').value.toLowerCase();

            const filtered = allPrices.filter(p => {
                const matchCategory = !categoryId || p.category_id == categoryId;
                const matchPrice = p.price >= minPrice && p.price <= maxPrice;
                const matchRetailer = !retailer || (p.retailer && p.retailer.toLowerCase().includes(retailer));
                const matchLocation = !location || (p.location && p.location.toLowerCase().includes(location));
                return matchCategory && matchPrice && matchRetailer && matchLocation;
            });

            displayPrices(filtered);
        }

        // Reset filters
        function resetFilters() {
            document.getElementById('filterCategory').value = '';
            document.getElementById('filterMinPrice').value = '';
            document.getElementById('filterMaxPrice').value = '';
            document.getElementById('filterRetailer').value = '';
            document.getElementById('filterLocation').value = '';
            displayPrices(allPrices);
        }

        // Add filter event listeners
        ['filterCategory', 'filterMinPrice', 'filterMaxPrice', 'filterRetailer', 'filterLocation'].forEach(id => {
            document.getElementById(id).addEventListener('change', applyFilters);
            document.getElementById(id).addEventListener('keyup', applyFilters);
        });

        // Submit price form
        document.getElementById('priceForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const userId = localStorage.getItem('userId');
            const priceData = {
                category_id: parseInt(document.getElementById('category').value),
                name: document.getElementById('itemName').value,
                brand: document.getElementById('brand').value || null,
                pack_size: document.getElementById('packSize').value || null,
                pack_unit: document.getElementById('packUnit').value || null,
                price: parseFloat(document.getElementById('price').value),
                price_per_unit: parseFloat(document.getElementById('pricePerUnit').value) || null,
                retailer: document.getElementById('retailer').value || null,
                location: document.getElementById('location').value || null,
                store_id: null,
                submitted_by: userId ? parseInt(userId) : null
            };

            try {
                const response = await fetch(`${API_URL}/items/prices/`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(priceData)
                });

                if (response.ok) {
                    const result = await response.json();
                    const successMsg = document.getElementById('successMsg');
                    successMsg.classList.add('show');
                    setTimeout(() => successMsg.classList.remove('show'), 3000);

                    // Save submission to user data
                    const userData = getUserData();
                    if (userData && result) {
                        if (!userData.submissions) userData.submissions = [];
                        userData.submissions.push({
                            id: result.id || Date.now(),
                            itemName: priceData.name,
                            price: priceData.price,
                            submittedAt: new Date().toISOString()
                        });
                        saveUserData(userData);
                    }

                    document.getElementById('priceForm').reset();
                    loadPrices();
                } else {
                    const errorData = await response.json();
                    alert('Error submitting price: ' + (errorData.detail || 'Check your inputs.'));
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error submitting price');
            }
        });

        // ===== NEW FEATURES =====

        // User Data Management
        function getUserData() {
            const userDataStr = localStorage.getItem('userData');
            if (userDataStr) {
                return JSON.parse(userDataStr);
            }
            return null;
        }

        function saveUserData(userData) {
            localStorage.setItem('userData', JSON.stringify(userData));
            // Also update in users storage
            const users = JSON.parse(localStorage.getItem('appUsers') || '{}');
            if (users[userData.username]) {
                users[userData.username] = userData;
                localStorage.setItem('appUsers', JSON.stringify(users));
            }
        }

        function loadUserData() {
            const userData = getUserData();
            if (userData) {
                return {
                    alerts: userData.alerts || [],
                    submissions: userData.submissions || [],
                    points: userData.points || 0,
                    reputation: userData.reputation || { score: 0, badge: 'New User' }
                };
            }
            return {
                alerts: [],
                submissions: [],
                points: 0,
                reputation: { score: 0, badge: 'New User' }
            };
        }

        // Price Alerts
        let priceAlerts = [];
        
        // Load user alerts on init
        function loadUserAlerts() {
            const userData = getUserData();
            if (userData && userData.alerts) {
                priceAlerts = userData.alerts;
            } else {
                priceAlerts = JSON.parse(localStorage.getItem('priceAlerts') || '[]');
            }
        }

        function saveUserAlerts() {
            const userData = getUserData();
            if (userData) {
                userData.alerts = priceAlerts;
                saveUserData(userData);
            }
            localStorage.setItem('priceAlerts', JSON.stringify(priceAlerts));
        }

        function openAlertModal(itemName, currentPrice) {
            document.getElementById('alertItemName').value = itemName;
            document.getElementById('alertThreshold').value = '';
            document.getElementById('alertModal').classList.add('open');
        }

        function closeAlertModal() {
            document.getElementById('alertModal').classList.remove('open');
        }

        function savePriceAlert() {
            const itemName = document.getElementById('alertItemName').value;
            const threshold = parseFloat(document.getElementById('alertThreshold').value);

            if (!itemName || !threshold) {
                alert('Please fill all fields');
                return;
            }

            const alert = {
                id: Date.now(),
                itemName,
                threshold,
                createdAt: new Date().toISOString(),
                triggered: false
            };

            priceAlerts.push(alert);
            saveUserAlerts();
            closeAlertModal();
            checkPriceAlerts();
            alert('‚úÖ Price alert set!');
        }

        function checkPriceAlerts() {
            priceAlerts.forEach(alert => {
                const matchingPrice = allPrices.find(p => 
                    p.name.toLowerCase() === alert.itemName.toLowerCase() && 
                    p.price <= alert.threshold && 
                    !alert.triggered
                );

                if (matchingPrice) {
                    alert.triggered = true;
                    showAlertNotification(alert, matchingPrice);
                }
            });

            saveUserAlerts();
            updateAlertBadges();
        }

        function showAlertNotification(alert, price) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 80px;
                right: 20px;
                background: var(--success);
                color: white;
                padding: 1rem;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                z-index: 3000;
                max-width: 300px;
            `;
            notification.innerHTML = `
                <strong>üîî Price Alert!</strong><br>
                ${alert.itemName} is now ‚Ç¶${price.price.toFixed(2)} (below ‚Ç¶${alert.threshold})
            `;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 5000);
        }

        function updateAlertBadges() {
            const activeAlerts = priceAlerts.filter(a => !a.triggered).length;
            const badges = document.querySelectorAll('.alert-badge');
            badges.forEach(badge => {
                if (activeAlerts > 0) {
                    badge.textContent = activeAlerts;
                    badge.classList.add('active');
                } else {
                    badge.classList.remove('active');
                }
            });
        }

        // Retailer Profile
        function showRetailerProfile(retailerName) {
            const retailerPrices = allPrices.filter(p => p.retailer === retailerName);
            
            if (retailerPrices.length === 0) {
                alert('No data available for this retailer');
                return;
            }

            document.getElementById('retailerProfileName').textContent = retailerName;
            document.getElementById('retailerLocation').textContent = retailerPrices[0].location || '-';
            document.getElementById('retailerItemsCount').textContent = retailerPrices.length;

            // Calculate avg price score
            const avgPrice = retailerPrices.reduce((sum, p) => sum + p.price, 0) / retailerPrices.length;
            document.getElementById('retailerAvgPrice').textContent = `‚Ç¶${avgPrice.toFixed(2)}`;

            // Cheapest items
            const cheapest = [...retailerPrices].sort((a, b) => a.price - b.price).slice(0, 5);
            document.getElementById('retailerCheapestItems').innerHTML = cheapest.map(p => `
                <div class="trending-item">
                    <span>${p.name}</span>
                    <span class="price-value">‚Ç¶${p.price.toFixed(2)}</span>
                </div>
            `).join('') || '<p>No items</p>';

            // Top items (most submitted)
            const itemCounts = {};
            retailerPrices.forEach(p => {
                itemCounts[p.name] = (itemCounts[p.name] || 0) + 1;
            });
            const topItems = Object.entries(itemCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5)
                .map(([name]) => {
                    const price = retailerPrices.find(p => p.name === name);
                    return { name, price: price.price };
                });
            document.getElementById('retailerTopItems').innerHTML = topItems.map(item => `
                <div class="trending-item">
                    <span>${item.name}</span>
                    <span class="price-value">‚Ç¶${item.price.toFixed(2)}</span>
                </div>
            `).join('') || '<p>No items</p>';

            document.getElementById('retailerModal').classList.add('open');
        }

        function closeRetailerModal() {
            document.getElementById('retailerModal').classList.remove('open');
        }

        // Search Autocomplete
        let searchTimeout;

        function performSearch(query) {
            const lowerQuery = query.toLowerCase();
            const results = {
                items: [],
                retailers: [],
                locations: []
            };

            // Search items
            allPrices.forEach(p => {
                if (p.name.toLowerCase().includes(lowerQuery) && 
                    !results.items.find(i => i.name === p.name)) {
                    results.items.push({ name: p.name, type: 'item', price: p.price });
                }
            });

            // Search retailers
            allPrices.forEach(p => {
                if (p.retailer && p.retailer.toLowerCase().includes(lowerQuery) && 
                    !results.retailers.find(r => r.name === p.retailer)) {
                    results.retailers.push({ name: p.retailer, type: 'retailer' });
                }
            });

            // Search locations
            allPrices.forEach(p => {
                if (p.location && p.location.toLowerCase().includes(lowerQuery) && 
                    !results.locations.find(l => l.name === p.location)) {
                    results.locations.push({ name: p.location, type: 'location' });
                }
            });

            return results;
        }

        function displaySearchResults(results) {
            const resultsDiv = document.getElementById('searchResults');
            if (!resultsDiv) return;

            const html = [
                ...results.items.slice(0, 5).map(item => `
                    <div class="search-result-item" onclick="selectSearchResult('item', '${item.name.replace(/'/g, "\\'")}')">
                        <strong>${item.name}</strong> - ‚Ç¶${item.price.toFixed(2)}
                    </div>
                `),
                ...results.retailers.slice(0, 3).map(retailer => `
                    <div class="search-result-item" onclick="selectSearchResult('retailer', '${retailer.name.replace(/'/g, "\\'")}')">
                        üè™ <strong>${retailer.name}</strong>
                    </div>
                `),
                ...results.locations.slice(0, 3).map(location => `
                    <div class="search-result-item" onclick="selectSearchResult('location', '${location.name.replace(/'/g, "\\'")}')">
                        üìç <strong>${location.name}</strong>
                    </div>
                `)
            ].join('');

            resultsDiv.innerHTML = html || '<div class="search-result-item">No results found</div>';
            resultsDiv.classList.add('open');
        }

        window.selectSearchResult = function(type, value) {
            const searchInput = document.getElementById('globalSearch');
            if (searchInput) searchInput.value = value;
            const resultsDiv = document.getElementById('searchResults');
            if (resultsDiv) resultsDiv.classList.remove('open');
            
            if (type === 'item') {
                const filterRetailer = document.getElementById('filterRetailer');
                const filterLocation = document.getElementById('filterLocation');
                if (filterRetailer) filterRetailer.value = '';
                if (filterLocation) filterLocation.value = '';
                // Filter by item name
                const filtered = allPrices.filter(p => p.name.toLowerCase().includes(value.toLowerCase()));
                displayPrices(filtered);
            } else if (type === 'retailer') {
                showRetailerProfile(value);
            } else if (type === 'location') {
                const filterLocation = document.getElementById('filterLocation');
                if (filterLocation) {
                    filterLocation.value = value;
                    applyFilters();
                }
            }
        };

        // Category Insights
        function showCategoryInsights() {
            const insights = {};
            
            allCategories.forEach(cat => {
                const catPrices = allPrices.filter(p => p.category_id === cat.id);
                if (catPrices.length === 0) return;

                const prices = catPrices.map(p => p.price);
                const avgPrice = prices.reduce((a, b) => a + b, 0) / prices.length;
                const minPrice = Math.min(...prices);
                const maxPrice = Math.max(...prices);

                // Top 5 trending (most submitted)
                const itemCounts = {};
                catPrices.forEach(p => {
                    itemCounts[p.name] = (itemCounts[p.name] || 0) + 1;
                });
                const trending = Object.entries(itemCounts)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 5)
                    .map(([name]) => {
                        const itemPrices = catPrices.filter(p => p.name === name).map(p => p.price);
                        return {
                            name,
                            avgPrice: itemPrices.reduce((a, b) => a + b, 0) / itemPrices.length,
                            count: itemCounts[name]
                        };
                    });

                // Latest submitted
                const latest = catPrices.sort((a, b) => 
                    new Date(b.submitted_at) - new Date(a.submitted_at)
                )[0];

                insights[cat.name] = {
                    avgPrice,
                    minPrice,
                    maxPrice,
                    totalSubmissions: catPrices.length,
                    trending,
                    latest: latest ? { name: latest.name, price: latest.price } : null
                };
            });

            let html = '';
            Object.entries(insights).forEach(([catName, data]) => {
                const cat = allCategories.find(c => c.name === catName);
                html += `
                    <div class="category-insight-card">
                        <div class="category-insight-header">
                            <span class="category-insight-title">${cat?.icon || ''} ${catName}</span>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-bottom: 1rem;">
                            <div>
                                <strong>Average Price:</strong> ‚Ç¶${data.avgPrice.toFixed(2)}
                            </div>
                            <div>
                                <strong>Total Submissions:</strong> ${data.totalSubmissions}
                            </div>
                            <div>
                                <strong>Cheapest:</strong> ‚Ç¶${data.minPrice.toFixed(2)}
                            </div>
                            <div>
                                <strong>Most Expensive:</strong> ‚Ç¶${data.maxPrice.toFixed(2)}
                            </div>
                        </div>
                        <div>
                            <h4 style="margin-bottom: 0.5rem;">üî• Top 5 Trending Items</h4>
                            ${data.trending.map(item => `
                                <div class="trending-item">
                                    <span>${item.name}</span>
                                    <span>‚Ç¶${item.avgPrice.toFixed(2)} (${item.count} submissions)</span>
                                </div>
                            `).join('')}
                        </div>
                        ${data.latest ? `
                            <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border);">
                                <strong>Latest:</strong> ${data.latest.name} - ‚Ç¶${data.latest.price.toFixed(2)}
                            </div>
                        ` : ''}
                    </div>
                `;
            });

            document.getElementById('categoryInsightsContent').innerHTML = html || '<p>No data available</p>';
            document.getElementById('categoryInsightsModal').classList.add('open');
        }

        function closeCategoryInsights() {
            document.getElementById('categoryInsightsModal').classList.remove('open');
        }

        // User Reputation/Trust Score
        function calculateUserReputation() {
            const userId = localStorage.getItem('userId');
            const userPrices = allPrices.filter(p => p.submitted_by == userId);
            
            if (userPrices.length === 0) {
                return { score: 0, badge: 'New User', class: 'reputation-suspicious' };
            }

            // Simple scoring: more submissions = higher score
            // Approved prices boost score
            const approvedCount = userPrices.filter(p => p.status === 'approved').length;
            const totalCount = userPrices.length;
            const approvalRate = approvedCount / totalCount;
            
            let score = (totalCount * 0.5) + (approvalRate * 5);
            score = Math.min(score, 5); // Cap at 5

            let badge, badgeClass;
            if (score >= 4) {
                badge = 'Trusted User';
                badgeClass = 'reputation-trusted';
            } else if (score >= 2) {
                badge = 'Regular User';
                badgeClass = 'reputation-trusted';
            } else {
                badge = 'Suspicious User';
                badgeClass = 'reputation-suspicious';
            }

            return { score: score.toFixed(1), badge, class: badgeClass };
        }

        function updateUserReputation() {
            const reputation = calculateUserReputation();
            const reputationElements = document.querySelectorAll('.user-reputation');
            
            reputationElements.forEach(el => {
                const scoreEl = el.querySelector('.reputation-score');
                const badgeEl = el.querySelector('.reputation-badge');
                
                if (scoreEl) scoreEl.textContent = reputation.score;
                if (badgeEl) {
                    badgeEl.textContent = reputation.badge;
                    badgeEl.className = `reputation-badge ${reputation.class}`;
                }
            });
        }

        // Profile Modal
        function showProfile() {
            const userId = localStorage.getItem('userId');
            const userName = localStorage.getItem('userName') || 'User';
            const userData = getUserData();
            const userPrices = allPrices.filter(p => p.submitted_by == userId);
            const reputation = calculateUserReputation();
            
            // Calculate points (1 point per approved submission)
            const points = userPrices.filter(p => p.status === 'approved').length * 1;
            
            // Update user data
            if (userData) {
                userData.points = points;
                userData.reputation = {
                    score: reputation.score,
                    badge: reputation.badge,
                    class: reputation.class
                };
                saveUserData(userData);
            }

            document.getElementById('profileUsername').value = userName;
            document.getElementById('profileSubmissions').value = userPrices.length;
            document.getElementById('profilePoints').value = `${points} points`;
            document.getElementById('userReputationScore').textContent = reputation.score;
            document.getElementById('userReputationBadge').textContent = reputation.badge;
            document.getElementById('userReputationBadge').className = `reputation-badge ${reputation.class}`;

            // Show alerts
            const userAlerts = priceAlerts.filter(a => !a.triggered);
            document.getElementById('profileAlertsList').innerHTML = userAlerts.length > 0 
                ? userAlerts.map(alert => `
                    <div style="padding: 0.8rem; background: var(--light); border-radius: 8px; margin-bottom: 0.5rem;">
                        <strong>${alert.itemName}</strong> - Alert when below ‚Ç¶${alert.threshold}
                        <button onclick="deleteAlert(${alert.id})" style="float: right; background: var(--danger); color: white; border: none; padding: 0.3rem 0.6rem; border-radius: 4px; cursor: pointer;">Delete</button>
                    </div>
                `).join('')
                : '<p>No active alerts</p>';

            document.getElementById('profileModal').classList.add('open');
        }

        function closeProfileModal() {
            document.getElementById('profileModal').classList.remove('open');
        }

        function deleteAlert(alertId) {
            priceAlerts = priceAlerts.filter(a => a.id !== alertId);
            saveUserAlerts();
            showProfile();
            updateAlertBadges();
        }

        // Mobile Navigation
        function showHome() {
            document.querySelectorAll('.mobile-nav-item').forEach(item => item.classList.remove('active'));
            event.target.closest('.mobile-nav-item').classList.add('active');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function showTrends() {
            document.querySelectorAll('.mobile-nav-item').forEach(item => item.classList.remove('active'));
            event.target.closest('.mobile-nav-item').classList.add('active');
            showCategoryInsights();
        }

        function scrollToSubmit() {
            document.querySelectorAll('.mobile-nav-item').forEach(item => item.classList.remove('active'));
            event.target.closest('.mobile-nav-item').classList.add('active');
            document.querySelector('.sidebar').scrollIntoView({ behavior: 'smooth' });
        }

        function openLocationPicker() {
            document.querySelectorAll('.mobile-nav-item').forEach(item => item.classList.remove('active'));
            event.target.closest('.mobile-nav-item').classList.add('active');
            mapPickerBtn.click();
        }

        function showMyAlerts() {
            const userAlerts = priceAlerts.filter(a => !a.triggered);
            if (userAlerts.length === 0) {
                alert('You have no active price alerts');
                return;
            }
            showProfile();
        }

        // Initialize search autocomplete
        const globalSearchInput = document.getElementById('globalSearch');
        if (globalSearchInput) {
            globalSearchInput.addEventListener('input', (e) => {
                const query = e.target.value.trim();
                clearTimeout(searchTimeout);
                
                const resultsDiv = document.getElementById('searchResults');
                if (!resultsDiv) return;

                if (query.length < 2) {
                    resultsDiv.classList.remove('open');
                    return;
                }

                searchTimeout = setTimeout(() => {
                    const results = performSearch(query);
                    displaySearchResults(results);
                }, 300);
            });
        }

        // Wrap displayPrices to add new features
        const originalDisplayPrices = displayPrices;
        displayPrices = function(prices) {
            originalDisplayPrices(prices);
            setTimeout(() => {
                checkPriceAlerts();
                updateUserReputation();
                updateAlertBadges();
            }, 100);
        };

        // Initialize
        loadUserAlerts();
        loadCategories();
        loadPrices();

        // Update user info display and restore user data
        window.addEventListener('DOMContentLoaded', () => {
            // Check if user is logged in
            const userRole = localStorage.getItem('userRole');
            if (!userRole || userRole !== 'user') {
                window.location.href = 'login.html';
                return;
            }

            const userName = localStorage.getItem('userName') || 'Student';
            const userData = getUserData();
            
            // Restore user data
            if (userData) {
                if (userData.alerts) {
                    priceAlerts = userData.alerts;
                }
            }

            // Calculate and update reputation
            const reputation = calculateUserReputation();
            
            // Update user data with current reputation
            if (userData) {
                userData.reputation = {
                    score: reputation.score,
                    badge: reputation.badge,
                    class: reputation.class
                };
                saveUserData(userData);
            }

            document.getElementById('user-info').innerHTML = `
                <span class="user-reputation">
                    <span>‚≠ê</span>
                    <span class="reputation-score">${reputation.score}</span>
                    <span class="reputation-badge ${reputation.class}">${reputation.badge}</span>
                </span>
            `;

            // Save user submissions when prices are loaded
            setTimeout(() => {
                const userId = localStorage.getItem('userId');
                if (userId && userData) {
                    const userSubmissions = allPrices.filter(p => p.submitted_by == userId);
                    userData.submissions = userSubmissions.map(p => ({
                        id: p.id,
                        itemName: p.name,
                        price: p.price,
                        submittedAt: p.submitted_at
                    }));
                    saveUserData(userData);
                }
            }, 2000);
        });

        // Logout function
        function logout() {
            localStorage.clear();
            window.location.href = 'login.html';
        }
    </script>
</body>
</html>
